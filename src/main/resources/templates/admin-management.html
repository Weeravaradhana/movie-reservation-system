<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Management</title>

  <!-- Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

  <style>
    body {
      background-color: #f5f6fa;
      font-family: 'Poppins', sans-serif;
      padding: 30px;
    }

    .container {
      background: white;
      padding: 30px;
      border-radius: 20px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
    }

    h2 {
      font-weight: 600;
      margin-bottom: 20px;
      color: #333;
    }

    form input, form select {
      margin-bottom: 10px;
      padding: 10px;
    }

    .btn-primary {
      background-color: #4e73df;
      border: none;
    }

    .btn-primary:hover {
      background-color: #3757c5;
    }

    table {
      margin-top: 20px;
    }

    table th {
      background: #4e73df;
      color: white;
    }

    .alert {
      display: none;
    }
  </style>
</head>
<body>

<div class="container">
  <!-- Navbar -->
  <nav class="navbar navbar-expand-lg navbar-dark sticky-top shadow-sm">
    <div class="container">
      <a class="navbar-brand" th:href="@{/}">MovieReserve</a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navbarNav">
        <ul class="navbar-nav ms-auto">
          <li class="nav-item"><a class="nav-link" th:href="@{/}">Home</a></li>
          <li class="nav-item"><a class="nav-link" th:href="@{/booking/movie/1}">Movies</a></li>
          <li class="nav-item"><a class="nav-link" th:href="@{/signup}">Sign Up</a></li>
          <li class="nav-item"><a class="nav-link" th:href="@{/login}">Login</a></li>
        </ul>
      </div>
    </div>
  </nav>
  <h2>Admin Management</h2>

  <!-- ‚úÖ Alert Message -->
  <div id="alertBox" class="alert alert-success" role="alert"></div>

  <!-- ‚úÖ Create / Promote Admin Form -->
  <form id="createAdminForm">
    <div class="row">
      <div class="col-md-6">
        <input type="text" id="fullName" class="form-control" placeholder="Full Name" required>
      </div>
      <div class="col-md-6">
        <input type="text" id="username" class="form-control" placeholder="Username" required>
      </div>
    </div>
    <div class="row">
      <div class="col-md-6">
        <input type="password" id="password" class="form-control" placeholder="Password" required>
      </div>
      <div class="col-md-3">
        <select id="role" class="form-select" required>
          <option value="" disabled selected>Select Role</option>
          <option value="SUPER_ADMIN">SUPER_ADMIN</option>
          <option value="STAFF">STAFF</option>
        </select>
      </div>
      <div class="col-md-3">
        <select id="status" class="form-select" required>
          <option value="" disabled selected>Select Status</option>
          <option value="ACTIVE">ACTIVE</option>
          <option value="INACTIVE">INACTIVE</option>
        </select>
      </div>
    </div>
    <button class="btn btn-primary mt-3" type="submit">Create / Promote Admin</button>
  </form>

  <hr>

  <!-- ‚úÖ Admin Table -->
  <h4>All Admins</h4>
  <table class="table table-striped" id="adminTable">
    <thead>
    <tr>
      <th>Admin ID</th>
      <th>Full Name</th>
      <th>Username</th>
      <th>Role</th>
      <th>Status</th>
      <th>Actions</th>
    </tr>
    </thead>
    <tbody>
    <!-- JS will load data -->
    </tbody>
  </table>
</div>

<script>
  const apiBase = '/admin-management-service/api/v1/admins';
  const adminTableBody = document.querySelector('#adminTable tbody');
  const alertBox = document.getElementById('alertBox');

  // ‚úÖ Show alert message
  function showAlert(message, type = 'success') {
    alertBox.textContent = message;
    alertBox.className = `alert alert-${type}`;
    alertBox.style.display = 'block';
    setTimeout(() => alertBox.style.display = 'none', 3000);
  }

  // ‚úÖ Load All Admins
  async function loadAdmins() {
    const res = await fetch(apiBase);
    const data = await res.json();
    if (res.ok && data.data) {
      adminTableBody.innerHTML = '';
      data.data.forEach(admin => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
                    <td>${admin.adminId}</td>
                    <td>${admin.fullName}</td>
                    <td>${admin.username}</td>
                    <td>${admin.role}</td>
                    <td>${admin.status}</td>
                    <td>
                        <button class="btn btn-sm btn-warning" onclick="editAdmin('${admin.adminId}')">Edit</button>
                        <button class="btn btn-sm btn-danger" onclick="deleteAdmin('${admin.adminId}')">Delete</button>
                    </td>
                `;
        adminTableBody.appendChild(tr);
      });
    }
  }

  // ‚úÖ Create Admin
  const createForm = document.getElementById('createAdminForm');
  createForm.addEventListener('submit', async (e) => {
    e.preventDefault();

    const payload = {
      fullName: document.getElementById('fullName').value.trim(),
      username: document.getElementById('username').value.trim(),
      password: document.getElementById('password').value,
      role: document.getElementById('role').value,
      status: document.getElementById('status').value
    };

    const res = await fetch(apiBase, {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify(payload)
    });

    const data = await res.json();
    if (res.ok) {
      showAlert('‚úÖ Admin created successfully!');
      createForm.reset();
      loadAdmins();
    } else {
      showAlert(data.message || '‚ùå Error creating admin', 'danger');
    }
  });

  // ‚úÖ Delete Admin
  async function deleteAdmin(id) {
    if (!confirm('Are you sure you want to delete this admin?')) return;

    const res = await fetch(`${apiBase}/${id}`, {method: 'DELETE'});
    const data = await res.json();

    if (res.ok) {
      showAlert('üóëÔ∏è Admin deleted successfully');
      loadAdmins();
    } else {
      showAlert(data.message || '‚ùå Error deleting admin', 'danger');
    }
  }

  // ‚úÖ Edit / Update Admin
  async function editAdmin(id) {
    const res = await fetch(`${apiBase}/${id}`);
    const data = await res.json();

    if (res.ok) {
      const admin = data.data;
      document.getElementById('fullName').value = admin.fullName;
      document.getElementById('username').value = admin.username;
      document.getElementById('role').value = admin.role;
      document.getElementById('status').value = admin.status;

      showAlert('‚úèÔ∏è Editing mode enabled');

      createForm.onsubmit = async (e) => {
        e.preventDefault();
        const payload = {
          fullName: document.getElementById('fullName').value.trim(),
          username: document.getElementById('username').value.trim(),
          password: document.getElementById('password').value,
          role: document.getElementById('role').value,
          status: document.getElementById('status').value
        };
        const resUpdate = await fetch(`${apiBase}/${id}`, {
          method: 'PUT',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify(payload)
        });
        const dataUpdate = await resUpdate.json();
        if (resUpdate.ok) {
          showAlert('‚úÖ Admin updated successfully!');
          createForm.reset();
          createForm.onsubmit = null;
          loadAdmins();
        } else {
          showAlert(dataUpdate.message || '‚ùå Error updating admin', 'danger');
        }
      };
    } else {
      showAlert('‚ö†Ô∏è Error fetching admin data', 'danger');
    }
  }

  // ‚úÖ Load Admins on Page Load
  loadAdmins();
</script>

</body>
</html>
