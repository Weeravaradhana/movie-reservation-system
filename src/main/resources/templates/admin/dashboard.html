<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - MovieReserve</title>


    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">


    <style>
        body { background-color: #121212; color: #e0e0e0; font-family: 'Segoe UI', sans-serif; }
        .card { background-color: #1f1f1f; border: none; border-radius: 12px; transition: transform 0.2s, box-shadow 0.2s; }
        .card:hover { transform: translateY(-5px); box-shadow: 0 10px 20px rgba(0,0,0,0.5); }
        .nav-pills .nav-link { background-color: #1f1f1f; color: #e0e0e0; margin-bottom: 5px; border-radius: 10px; transition: all 0.2s; }
        .nav-pills .nav-link.active { background-color: #3a3a3a; color: #fff; }
        .nav-pills .nav-link:hover { background-color: #333; color: #fff; }
        .table { color: #e0e0e0; }
        .table th, .table td { vertical-align: middle; }
        .btn-primary, .btn-danger { border-radius: 8px; }
        .badge { font-size: 0.8rem; }
        .card-body { max-height: 90vh; overflow-y: auto; }
        .card-body::-webkit-scrollbar { width: 6px; }
        .card-body::-webkit-scrollbar-thumb { background-color: #444; border-radius: 10px; }
        .card-body::-webkit-scrollbar-track { background-color: #1f1f1f; }
    </style>
</head>
<body>
<!-- Navbar -->
<nav class="navbar navbar-expand-lg navbar-dark sticky-top shadow-sm">
    <div class="container">
        <a class="navbar-brand" th:href="@{/}">MovieReserve</a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
            <ul class="navbar-nav ms-auto">
                <li class="nav-item"><a class="nav-link" th:href="@{/}">Home</a></li>
                <li class="nav-item"><a class="nav-link" th:href="@{/booking/movie/1}">Movies</a></li>
                <li class="nav-item"><a class="nav-link" th:href="@{/signup}">Sign Up</a></li>
                <li class="nav-item"><a class="nav-link" th:href="@{/login}">Login</a></li>
            </ul>
        </div>
    </div>
</nav>
<div class="container-fluid py-4">
    <div class="row">
        <!-- Sidebar -->
        <div class="col-lg-3 col-md-4 mb-3">
            <div class="card shadow-sm">
                <div class="card-body">
                    <div class="text-center mb-3">
                        <i class="fas fa-user-shield fa-4x text-primary"></i>
                        <h5 class="mt-2" th:text="${session.loggedUserEmail}">admin@example.com</h5>
                        <span class="badge bg-success">Admin</span>
                    </div>
                    <hr class="border-secondary">
                    <ul class="nav nav-pills flex-column">
                        <li class="nav-item"><a class="nav-link active" href="#dashboard" data-bs-toggle="tab"><i class="fas fa-tachometer-alt me-2"></i>Dashboard</a></li>
                        <li class="nav-item"><a class="nav-link" href="#movies" data-bs-toggle="tab"><i class="fas fa-film me-2"></i>Movies</a></li>
                        <li class="nav-item"><a class="nav-link" href="#showtimes" data-bs-toggle="tab"><i class="fas fa-clock me-2"></i>Showtimes</a></li>
                        <li class="nav-item"><a class="nav-link" href="#deals" data-bs-toggle="tab"><i class="fas fa-tags me-2"></i>Deals / Promo</a></li>
                        <li class="nav-item"><a class="nav-link" href="#payments" data-bs-toggle="tab"><i class="fas fa-money-bill-wave me-2"></i>Payments</a></li>
                        <li class="nav-item"><a class="nav-link" href="#reviews" data-bs-toggle="tab"><i class="fas fa-star me-2"></i>Reviews</a></li>
                        <li class="nav-item"><a class="nav-link" href="#tickets" data-bs-toggle="tab"><i class="fas fa-ticket-alt me-2"></i>Tickets</a></li>
                        <li class="nav-item"><a class="nav-link" href="#logs" data-bs-toggle="tab"><i class="fas fa-clipboard-list me-2"></i>System Logs</a></li>
                    </ul>
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="col-lg-9 col-md-8">
            <div class="tab-content">
                <!-- Dashboard Overview -->
                <div class="tab-pane fade show active" id="dashboard">
                    <div class="row">
                        <div class="col-6 mb-3">
                            <div class="card text-white bg-primary">
                                <div class="card-body">
                                    <h5 class="card-title">Total Movies</h5>
                                    <h3 id="totalMovies">0</h3>
                                </div>
                            </div>
                        </div>
                        <div class="col-6 mb-3">
                            <div class="card text-white bg-success">
                                <div class="card-body">
                                    <h5 class="card-title">Total Bookings</h5>
                                    <h3 id="totalBookings">0</h3>
                                </div>
                            </div>
                        </div>
                        <div class="col-6 mb-3">
                            <div class="card text-white bg-warning">
                                <div class="card-body">
                                    <h5 class="card-title">Revenue</h5>
                                    <h3 id="totalRevenue">$0</h3>
                                </div>
                            </div>
                        </div>
                        <div class="col-6 mb-3">
                            <div class="card text-white bg-danger">
                                <div class="card-body">
                                    <h5 class="card-title">Users</h5>
                                    <h3 id="totalUsers">0</h3>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Showtimes Tab -->

                <div class="tab-pane fade" id="showtimes">
                    <h3>All Showtimes</h3>
                    <li class="nav-item"><a class="nav-link" th:href="@{/showtimes}">Manage showtime</a></li>
                    <div class="table-responsive">
                        <table class="table table-hover table-dark" id="showtimesTable">
                            <thead>
                            <tr>
                                <th>#</th>
                                <th>Title</th>
                                <th>Date</th>
                                <th>Time</th>
                                <th>Hall</th>
                            </tr>
                            </thead>
                            <tbody id="showtimesTableBody"></tbody>
                        </table>
                    </div>
                </div>

                <!-- Deals / Promo Tab -->
                <div class="tab-pane fade" id="deals">
                    <h3>Active Deals / Promo</h3>
                    <li class="nav-item"><a class="nav-link" th:href="@{/deal}">Manage deal</a></li>
                    <li class="nav-item"><a class="nav-link" th:href="@{/promo-code}">Manage promocode</a></li>
                    <div class="table-responsive">
                        <table class="table table-hover table-dark" id="dealsTable">
                            <thead>
                            <tr>
                                <th>#</th>
                                <th>Promo code</th>
                                <th>Discount</th>
                                <th>Valid From</th>
                                <th>Valid To</th>
                            </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>

                <!-- Payments Tab -->
                <div class="tab-pane fade" id="payments">
                    <h3>All Payments</h3>
                    <li class="nav-item"><a class="nav-link" th:href="@{/payment}">Manage payment</a></li>
                    <div class="table-responsive">
                        <table class="table table-hover table-dark" id="paymentsTable">
                            <thead>
                            <tr>
                                <th>#</th>
                                <th>Card Holder</th>
                                <th>Card Number</th>
                                <th>Booking ID</th>
                                <th>Amount</th>
                                <th>Method</th>
                                <th>Status</th>
                                <th>Timestamp</th>
                            </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>

                <!-- Reviews Tab -->
                <div class="tab-pane fade" id="reviews">
                    <h3>User Reviews</h3>
                    <li class="nav-item"><a class="nav-link" th:href="@{/review}">Manage review</a></li>
                    <div class="table-responsive">
                        <table class="table table-hover table-dark" id="reviewsTable">
                            <thead>
                            <tr>
                                <th>#</th>
                                <th>Admin Response</th>
                                <th>Create At</th>
                                <th>Rating</th>
                                <th>Comment</th>
                                <th>Movie id</th>
                            </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>

                <!-- Tickets Tab -->
                <div class="tab-pane fade" id="tickets">
                    <h3>All Tickets</h3>
                    <li class="nav-item"><a class="nav-link" th:href="@{/tickets}">Manage Ticket</a></li>
                    <div class="table-responsive">
                        <table class="table table-hover table-dark" id="ticketsTable">
                            <thead>
                            <tr>
                                <th>#</th>
                                <th>Title</th>
                                <th>Description</th>
                                <th>Status</th>
                                <th>Priority</th>
                                <th>User</th>
                                <th>Assigned Admin</th>
                                <th>Refund Amount</th>
                                <th>Created At</th>
                                <th>Updated At</th>
                                <th>Resolved At</th>
                                <th>Admin Response</th>
                                <th>Admin Response At</th>
                                <th>Action</th>
                            </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>

                <!-- System Logs Tab -->
                <div class="tab-pane fade" id="logs">
                    <h3>System Logs</h3>
                    <button class="btn btn-sm btn-danger mb-2" onclick="clearAllLogs()">Clear All Logs</button>
                    <div class="table-responsive">
                        <table class="table table-hover table-dark" id="logsTable">
                            <thead>
                            <tr>
                                <th>#</th>
                                <th>ID</th>
                                <th>Action</th>
                                <th>User</th>
                                <th>Timestamp</th>
                                <th>Details</th>
                                <th>Action</th>
                            </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>

            </div>
        </div>
    </div>
</div>

<!-- Scripts -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {

        // ===== Showtimes =====
        async function loadShowtimes() {
            try {
                const res = await fetch('/show-time-management-service/api/v1/showtimes/find-all');
                const data = await res.json();
                const tbody = document.querySelector("#showtimesTableBody");
                tbody.innerHTML = "";
                if (!data || data.length === 0) {
                    tbody.innerHTML = "<tr><td colspan='5' style='text-align:center'>No showtimes found</td></tr>";
                    return;
                }
                data.forEach((showtime, index) => {
                    tbody.innerHTML += `
                    <tr>
                        <td>${index + 1}</td>
                        <td>${showtime.movie?.title || 'N/A'}</td>
                        <td>${showtime.date}</td>
                        <td>${showtime.time}</td>
                        <td>${showtime.hall?.name || 'N/A'}</td>
                    </tr>`;
                });
            } catch(err) { console.error(err); }
        }

        // ===== Deals =====
        async function loadActiveDeals() {
            try {
                const res = await fetch(`/deal-management-service/api/v1/deals/visitor/find-all?searchText=&page=0&size=10`);
                const json = await res.json();
                const deals = json.data?.dataList || [];
                const tbody = document.querySelector("#dealsTable tbody");
                tbody.innerHTML = "";
                const activeDeals = deals.filter(d => d.status === true);
                if (activeDeals.length === 0) {
                    tbody.innerHTML = "<tr><td colspan='5' style='text-align:center'>No active deals</td></tr>";
                    return;
                }
                activeDeals.forEach((deal, index) => {
                    tbody.innerHTML += `
                    <tr>
                        <td>${index + 1}</td>
                        <td>${deal.code}</td>
                        <td>${deal.discount}</td>
                        <td>${new Date(deal.startDate).toLocaleDateString()}</td>
                        <td>${new Date(deal.endDate).toLocaleDateString()}</td>
                    </tr>`;
                });
            } catch(err) { console.error(err); }
        }

        // ===== Payments =====
        async function loadPayments() {
            try {
                const res = await fetch(`/payment-management-service/api/v1/payments/admin/find-all`);
                const json = await res.json();
                const payments = json.data || [];
                const tbody = document.querySelector("#paymentsTable tbody");
                tbody.innerHTML = "";
                if (payments.length === 0) {
                    tbody.innerHTML = "<tr><td colspan='8' style='text-align:center'>No payments found</td></tr>";
                    return;
                }
                payments.forEach((p, i) => {
                    tbody.innerHTML += `
                    <tr>
                        <td>${i + 1}</td>
                        <td>${p.cardHolderName}</td>
                        <td>${p.cardNumber}</td>
                        <td>${p.booking?.id || ''}</td>
                        <td>${p.amount}</td>
                        <td>${p.method}</td>
                        <td>${p.status}</td>
                        <td>${new Date(p.timestamp).toLocaleString()}</td>
                    </tr>`;
                });
            } catch(err) { console.error(err); }
        }

        // ===== Reviews =====
        async function loadReviews() {
            try {
                const res = await fetch(`/review-management-service/api/v1/reviews/admin/find-all`);
                const json = await res.json();
                const reviews = json.data || json || [];
                const tbody = document.querySelector("#reviewsTable tbody");
                tbody.innerHTML = "";
                if (reviews.length === 0) {
                    tbody.innerHTML = "<tr><td colspan='6' style='text-align:center'>No reviews found</td></tr>";
                    return;
                }
                reviews.forEach((r, i) => {
                    tbody.innerHTML += `
                    <tr>
                        <td>${i + 1}</td>
                        <td>${r.adminResponse}</td>
                        <td>${new Date(r.createdAt).toLocaleDateString()}</td>
                        <td>${r.rating}</td>
                        <td>${r.content}</td>
                        <td>${r.id}</td>
                    </tr>`;
                });
            } catch(err) { console.error(err); }
        }

        // ===== Tickets =====
        async function loadTickets() {
            try {
                const res = await fetch('/ticket-management-service/api/v1/tickets/admin/all/paged?page=0&size=50');
                const json = await res.json();
                const tickets = json.data?.dataList || [];
                const tbody = document.querySelector("#ticketsTable tbody");
                tbody.innerHTML = "";
                if (tickets.length === 0) {
                    tbody.innerHTML = "<tr><td colspan='14' style='text-align:center'>No tickets found</td></tr>";
                    return;
                }
                tickets.forEach((t, i) => {
                    tbody.innerHTML += `
                    <tr data-ticket-id="${t.id}">
                        <td>${i + 1}</td>
                        <td>${t.title || ''}</td>
                        <td>${t.description || ''}</td>
                        <td>${t.status || ''}</td>
                        <td>${t.priority || ''}</td>
                        <td>${t.username || t.userId || ''}</td>
                        <td>${t.assignedAdminUsername || t.assignedAdminId || ''}</td>
                        <td>${t.refundAmount || 0}</td>
                        <td>${t.createdAt ? new Date(t.createdAt).toLocaleString() : ''}</td>
                        <td>${t.updatedAt ? new Date(t.updatedAt).toLocaleString() : ''}</td>
                        <td>${t.resolvedAt ? new Date(t.resolvedAt).toLocaleString() : ''}</td>
                        <td>${t.adminResponse || ''}</td>
                        <td>${t.adminResponseAt ? new Date(t.adminResponseAt).toLocaleString() : ''}</td>
                        <td>
                            <button class="btn btn-sm btn-primary me-1" onclick="openAdminResponseModal(${t.id})">Respond</button>
                            <button class="btn btn-sm btn-warning me-1" onclick="updateTicketStatus(${t.id})">Status</button>
                            <button class="btn btn-sm btn-info me-1" onclick="updateTicketPriority(${t.id})">Priority</button>
                            <button class="btn btn-sm btn-danger" onclick="deleteTicket(${t.id})">Delete</button>
                        </td>
                    </tr>`;
                });
            } catch(err) { console.error(err); }
        }

        // ===== Ticket Action Functions =====
        window.openAdminResponseModal = function (ticketId) {
            const response = prompt("Enter admin response:");
            if (response !== null) {
                fetch(`/ticket-management-service/api/v1/tickets/admin/${ticketId}/response?response=${encodeURIComponent(response)}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ adminResponse: response })
                }).then(() => loadTickets());
            }
        }

        window.updateTicketStatus=function (ticketId) {
            const status = prompt("Enter new status:");
            if (status !== null) {
                fetch(`/ticket-management-service/api/v1/tickets/admin/${ticketId}/status?status=${encodeURIComponent(status)}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ status: status })
                }).then(() => loadTickets());
            }
        }

        window.updateTicketPriority=function (ticketId) {
            const priority = prompt("Enter new priority:");
            if (priority !== null) {
                fetch(`/ticket-management-service/api/v1/tickets/admin/${ticketId}/priority?priority=${encodeURIComponent(priority)}`, {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ priority: priority })
                }).then(() => loadTickets());
            }
        }

        window.deleteTicket=function (ticketId) {
            if (confirm("Are you sure you want to delete this ticket?")) {
                fetch(`/ticket-management-service/api/v1/tickets/admin/${ticketId}`, { method: 'DELETE' })
                    .then(() => loadTickets());
            }
        }

        // ===== System Logs =====
        async function loadSystemLogs() {
            try {
                const res = await fetch('/log-management-service/api/v1/logs/admin/get-all');
                const json = await res.json();
                const logs = json.data || [];
                const tbody = document.querySelector("#logsTable tbody");
                tbody.innerHTML = "";

                if (logs.length === 0) {
                    tbody.innerHTML = "<tr><td colspan='7' style='text-align:center'>No logs found</td></tr>";
                    return;
                }

                logs.forEach((log, i) => {
                    tbody.innerHTML += `
                    <tr data-log-id="${log.id}">
                        <td>${i + 1}</td>
                        <td>${log.id}</td>
                        <td>${log.action}</td>
                        <td>${log.username || log.userId || 'N/A'}</td>
                        <td>${log.timestamp ? new Date(log.timestamp).toLocaleString() : ''}</td>
                        <td>${log.details || ''}</td>
                        <td>
                            <button class="btn btn-sm btn-danger" onclick="deleteLog(${log.id})">Delete</button>
                        </td>
                    </tr>`;
                });
            } catch (err) { console.error(err); }
        }

        window.deleteLog = function (logId) {
            if (confirm("Are you sure you want to delete this log?")) {
                fetch(`/log-management-service/api/v1/logs/admin/${logId}`, { method: 'DELETE' })
                    .then(() => loadSystemLogs());
            }
        };

        window.clearAllLogs = function () {
            if (confirm("Are you sure you want to clear all logs?")) {
                fetch(`/log-management-service/api/v1/logs/admin/delete-all`, { method: 'DELETE' })
                    .then(() => loadSystemLogs());
            }
        }

        // ===== Tab listeners =====
        document.querySelector('a[href="#showtimes"]').addEventListener('shown.bs.tab', loadShowtimes);
        document.querySelector('a[href="#deals"]').addEventListener('shown.bs.tab', loadActiveDeals);
        document.querySelector('a[href="#payments"]').addEventListener('shown.bs.tab', loadPayments);
        document.querySelector('a[href="#reviews"]').addEventListener('shown.bs.tab', loadReviews);
        document.querySelector('a[href="#tickets"]').addEventListener('shown.bs.tab', loadTickets);
        document.querySelector('a[href="#logs"]').addEventListener('shown.bs.tab', loadSystemLogs);

    });
</script>
</body>
</html>
